<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="msapplication-config" content="/images/site.webmanifest">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideRightIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="In the Introduction section, we already have a big picture of the Coroutines feature, including what it is, how we can use it, and other basic concepts. In this article, I will introduce another crit">
<meta property="og:type" content="article">
<meta property="og:title" content="Android Coroutines - Suspend, Resume, and Dispatch">
<meta property="og:url" content="http://yoursite.com/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/index.html">
<meta property="og:site_name" content="舊金山周記">
<meta property="og:description" content="In the Introduction section, we already have a big picture of the Coroutines feature, including what it is, how we can use it, and other basic concepts. In this article, I will introduce another crit">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://chauyanw.files.wordpress.com/2019/08/kotlin-coroutines-1.png?w=2924">
<meta property="article:published_time" content="2020-02-05T07:39:29.000Z">
<meta property="article:modified_time" content="2020-04-12T07:44:44.788Z">
<meta property="article:author" content="Chauyan">
<meta property="article:tag" content="Coroutines">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://chauyanw.files.wordpress.com/2019/08/kotlin-coroutines-1.png?w=2924">

<link rel="canonical" href="http://yoursite.com/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>Android Coroutines - Suspend, Resume, and Dispatch | 舊金山周記</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-149656006-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-149656006-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">舊金山周記</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">The Venture of San Francisco</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="tags fa-fw"></i>Tags<span class="badge">102</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="th fa-fw"></i>Categories<span class="badge">11</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="archive fa-fw"></i>Archives<span class="badge">67</span></a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chauyan">
      <meta itemprop="description" content="Personal dev blog for sharing what I've learned.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舊金山周記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android Coroutines - Suspend, Resume, and Dispatch
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-04 23:39:29" itemprop="dateCreated datePublished" datetime="2020-02-04T23:39:29-08:00">2020-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-12 00:44:44" itemprop="dateModified" datetime="2020-04-12T00:44:44-07:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-Dev/" itemprop="url" rel="index"><span itemprop="name">Android Dev</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://chauyanw.files.wordpress.com/2019/08/kotlin-coroutines-1.png?w=2924" alt="kotlin-coroutines-1.png?w=2924"></p>
<p>In the <a href="https://personaldevblog.firebaseapp.com/2019/12/27/Android-Coroutines-Introduction">Introduction</a> section, we already have a big picture of the <code>Coroutines</code> feature, including what it is, how we can use it, and other basic concepts. In this article, I will introduce another critical keyword <code>suspend</code>:</p>
<span id="more"></span>

<h4 id="What’s-a-suspend-function"><a href="#What’s-a-suspend-function" class="headerlink" title="What’s a suspend function?"></a>What’s a suspend function?</h4><p>Remember the example we use before:</p>
<pre><code class="highlight kotlin"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestToken</span><span class="params">()</span></span>: Token &#123; ... &#125;
<span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">createPost</span><span class="params">(token: <span class="type">Token</span>, item: <span class="type">Item</span>)</span></span>: Post &#123; ... &#125;
<span class="function"><span class="keyword">fun</span> <span class="title">processPost</span><span class="params">(post: <span class="type">Post</span>)</span></span> &#123; ... &#125;

<span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;
  GlobalScope.launch &#123;
    <span class="keyword">val</span> token = requestToken()
    <span class="keyword">val</span> post = createPost(token, item)
    processPost(post)
  &#125;
&#125;</code></pre>

<p>You can see the keyword <code>suspend</code> in front of a function. What does <code>suspend</code> keyword mean? If you compile the Kotlin code, you can see something like this:</p>
<pre><code class="highlight java"><span class="comment">// declaration: requestToken(kotlin.coroutines.Continuation&lt;? super kotlin.Unit&gt;)</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="title function_">requestToken</span><span class="params">(Lkotlin/coroutines/Continuation;)</span>Ljava/lang/Object;</code></pre>

<p>The code snap above is what we decompile into java code.</p>
<pre><code class="highlight kotlin"><span class="meta">@Nullable</span>
<span class="keyword">public</span> <span class="keyword">final</span> Object requestToken(<span class="meta">@NotNull</span> Continuation $completion) &#123;
  <span class="keyword">return</span> <span class="built_in">Unit</span>.INSTANCE;
&#125;</code></pre>

<p>This is a bytecode&#x2F;compiled-java-code sample for this suspend function - requestToken(). We can find there’s a parameter passed into requestToken(), which is a <code>Continuation.</code> What’s a <code>Continuation</code>?</p>
<pre><code class="highlight kotlin"><span class="comment">/**</span>
<span class="comment">* Interface representing a continuation after a suspension point that returns a value of type `T`.</span>
<span class="comment">*/</span>
<span class="meta">@SinceKotlin(<span class="string">&quot;1.3&quot;</span>)</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Continuation</span> &#123;
  <span class="comment">/**</span>
<span class="comment">  * The context of the coroutine that corresponds to this continuation.</span>
<span class="comment">  */</span>
  <span class="keyword">public</span> <span class="keyword">val</span> context: CoroutineContext

  <span class="comment">/**</span>
<span class="comment">  * Resumes the execution of the corresponding coroutine passing a successful or failed [result] as the</span>
<span class="comment">  * return value of the last suspension point.</span>
<span class="comment">  */</span>
  <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span>
&#125;</code></pre>

<p>It’s an interface for resuming the suspended point. Here’s an example when you try to use <code>CoroutineScope.Launch</code>:</p>
<pre><code class="highlight kotlin">GlobalScope.launch &#123;
  <span class="keyword">val</span> token = requestToken()
  <span class="keyword">val</span> post = createPost(token)
  processPost(post)
&#125;</code></pre>

<p>it will become something like:</p>
<pre><code class="highlight java"><span class="meta">@Nullable</span>
<span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;
  Object var10000;
  label17: &#123;
    <span class="type">Object</span> <span class="variable">var5</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();
    CoroutineScope $<span class="built_in">this</span>$launch;
    Token token;
    MainActivity var6;
    <span class="keyword">switch</span>(<span class="built_in">this</span>.label) &#123;
      <span class="keyword">case</span> <span class="number">0</span>:
        ResultKt.throwOnFailure($result);
        $<span class="built_in">this</span>$launch = <span class="built_in">this</span>.p$;
        var6 = MainActivity.<span class="built_in">this</span>;
        <span class="built_in">this</span>.L$<span class="number">0</span> = $<span class="built_in">this</span>$launch;
        <span class="built_in">this</span>.label = <span class="number">1</span>;
        var10000 = var6.requestToken(<span class="built_in">this</span>);
        <span class="keyword">if</span> (var10000 == var5) &#123;
          <span class="keyword">return</span> var5;
        &#125;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number">1</span>:
        $<span class="built_in">this</span>$launch = (CoroutineScope)<span class="built_in">this</span>.L$<span class="number">0</span>;
        ResultKt.throwOnFailure($result);
        var10000 = $result;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number">2</span>:
        token = (Token)<span class="built_in">this</span>.L$<span class="number">1</span>;
        $<span class="built_in">this</span>$launch = (CoroutineScope)<span class="built_in">this</span>.L$<span class="number">0</span>;
        ResultKt.throwOnFailure($result);
        var10000 = $result;
        <span class="keyword">break</span> label17;
      <span class="keyword">default</span>:
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);
    &#125;

    token = (Token)var10000;
    var6 = MainActivity.<span class="built_in">this</span>;
    <span class="built_in">this</span>.L$<span class="number">0</span> = $<span class="built_in">this</span>$launch;
    <span class="built_in">this</span>.L$<span class="number">1</span> = token;
    <span class="built_in">this</span>.label = <span class="number">2</span>;
    var10000 = var6.createPost(token, <span class="built_in">this</span>);
    <span class="keyword">if</span> (var10000 == var5) &#123;
      <span class="keyword">return</span> var5;
    &#125;
  &#125;

  <span class="type">Post</span> <span class="variable">post</span> <span class="operator">=</span> (Post)var10000;
  MainActivity.<span class="built_in">this</span>.processPost(post);
  <span class="keyword">return</span> Unit.INSTANCE;
&#125;</code></pre>

<p>In a Coroutine, it doesn’t use a callback function to return value. Instead, it uses the state machine to control what will respond to the next state. A suspend function will block the Coroutine when it’s in, but it wouldn’t block the thread. When it executes the suspend function, it won’t block the whole thread. The current thread can still do other jobs.</p>
<pre><code class="highlight kotlin">Thread &#123;

  <span class="keyword">val</span> context = newSingleThreadContext(<span class="string">&quot;Test Thread&quot;</span>)
  GlobalScope.launch (context) &#123;
    println(<span class="string">&quot;Start first coroutine.&quot;</span>)
    delay(<span class="number">200</span>)
    println(<span class="string">&quot;Resume first coroutine after delay 200ms&quot;</span>)
  &#125;

  GlobalScope.launch (context)&#123;
    println(<span class="string">&quot;Start second coroutine.&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;Resume second coroutine after delay 100ms&quot;</span>)
  &#125;

  Thread.sleep(<span class="number">500</span>)
&#125;.start()</code></pre>

<p>the result:</p>
<pre><code class="highlight text">2019-08-17 21:25:22.437 I/System.out: Start first coroutine.
2019-08-17 21:25:22.473 I/System.out: Start second coroutine.
2019-08-17 21:25:22.574 I/System.out: Resume second coroutine after delay 100ms
2019-08-17 21:25:22.656 I/System.out: Resume first coroutine after delay 200ms</code></pre>

<p>That’s why a Coroutine is very lightweight, and you can create it anytime without spending many resources on creating a Coroutine. After this, you might have a question: after resuming the suspended status, current Coroutine will still run on the same thread?</p>
<p>If you remember, I mentioned <code>Dispatcher</code> would decide which thread a Coroutine should run. There are two categories of dispatcher - <code>confined</code> &amp; <code>unconfined.</code> The <code>Default,</code> <code>Main,</code> and <code>IO</code> belong to <code>Confined</code> category, and <code>Unconfined</code> is <code>unconfined.</code> Let’s create two different coroutines and use <code>Confined</code> &amp; <code>Unconfined</code> dispatchers to see what will happen.</p>
<pre><code class="highlight kotlin">Thread &#123;
  GlobalScope.launch (Dispatchers.Main) &#123;
    println(<span class="string">&quot;First coroutine runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;First coroutine resumes and runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
&#125;

  GlobalScope.launch (Dispatchers.Unconfined)&#123;
    println(<span class="string">&quot;Second coroutine runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;Second coroutine resumes and runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
&#125;

  Thread.sleep(<span class="number">500</span>)
&#125;.start()</code></pre>

<p>Result:</p>
<pre><code class="highlight plaintext">2019-08-17 21:43:22.895 I/System.out: Second coroutine runs in Thread-4
2019-08-17 21:43:22.947 I/System.out: First coroutine runs in main
2019-08-17 21:43:23.005 I/System.out: Second coroutine resumes and runs in kotlinx.coroutines.DefaultExecutor
2019-08-17 21:43:23.050 I/System.out: First coroutine resumes and runs in main</code></pre>

<p>When you use a <code>confined</code> dispatcher, no matter when you suspend the Coroutine, it would still run on the same thread after it resumes for the <code>Dispatchers.Unconfined</code> setting, it would first start on the caller thread but continue on a thread based on where the suspend function is.</p>
<p>So far, I introduce how the suspend function works, but it’s still worth going through how to create a Coroutine, start it and resume mechanism, especially it would be great to know how to switch different Coroutines. Let’s dig in a little bit deeper.</p>
<p>Go back to the <code>CoroutineScope.Launch</code>:</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">launch</span><span class="params">(</span></span>
<span class="params"><span class="function">  context: <span class="type">CoroutineContext</span> = EmptyCoroutineContext,</span></span>
<span class="params"><span class="function">  start: <span class="type">CoroutineStart</span> = CoroutineStart.DEFAULT,</span></span>
<span class="params"><span class="function">  block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">Unit</span></span></span>
<span class="params"><span class="function">)</span></span>: Job &#123;
  <span class="keyword">val</span> newContext = newCoroutineContext(context)
  <span class="keyword">val</span> coroutine = <span class="keyword">if</span> (start.isLazy)
      LazyStandaloneCoroutine(newContext, block) 
    <span class="keyword">else</span>
      StandaloneCoroutine(newContext, active = <span class="literal">true</span>)
  coroutine.start(start, coroutine, block)
  <span class="keyword">return</span> coroutine
&#125;</code></pre>

<p>In general, the <code>start</code> parameter will be <code>CoroutineStart.DEFAULT</code>. It would go to here once the start function calls:</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(
  receiver: R, 
  completion: Continuation
) = runSafely(completion) &#123;
  createCoroutineUnintercepted(
    receiver, completion
  ).intercepted().resumeCancellable(<span class="built_in">Unit</span>)
&#125;</code></pre>

<p>It eventually calls the function - <code>createCoroutineUnintercepted</code> to create a Coroutine. What does this function do?</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="title">fun</span> <span class="params">(<span class="keyword">suspend</span> ()</span></span> -&gt; T).createCoroutineUnintercepted(
  completion: Continuation
): Continuation &#123;
  <span class="keyword">val</span> probeCompletion = probeCoroutineCreated(completion)
  <span class="keyword">return</span> <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> BaseContinuationImpl)
      create(probeCompletion)
    <span class="keyword">else</span>
      createCoroutineFromSuspendFunction(probeCompletion) &#123;
        (<span class="keyword">this</span> <span class="keyword">as</span> Function1&lt;Continuation, Any?&gt;).invoke(it)
      &#125;
&#125;</code></pre>

<p>It creates a Coroutine, which is not intercepted without a receiver but with a result type <code>T.</code> This function creates a new and fresh instance of suspendable computation every time when it is invoked. To start executing this prepared Coroutine, it would call <code>resume(Unit)</code> on the returned Continuation instance. So, remember <code>createCoroutineUnintercepted</code> that will call <code>resumeCancellable</code> to execute a created Coroutine.</p>
<p><strong>resumeCancellable</strong> function</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> Continuation.<span class="title">resumeCancellable</span><span class="params">(value: <span class="type">T</span>)</span></span> = <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;
  <span class="keyword">is</span> DispatchedContinuation -&gt; resumeCancellable(value)
  <span class="keyword">else</span> -&gt; resume(value)
&#125;</code></pre>

<p><strong>resume</strong> function</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> Continuation.<span class="title">resume</span><span class="params">(value: <span class="type">T</span>)</span></span>: <span class="built_in">Unit</span> =
  resumeWith(Result.success(value))</code></pre>

<p>In the resume function, it calls the <code>resumeWith</code> function in a Continuation. Let’s check how it works.</p>
<p><strong>BaseContinuationImpl</strong></p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseContinuationImpl</span>(
  <span class="comment">// This is `public val` so that it is private on JVM and cannot be modified by untrusted code, yet</span>
  <span class="comment">// it has a public getter (since even untrusted code is allowed to inspect its call stack).</span>
  <span class="keyword">public</span> <span class="keyword">val</span> completion: Continuation?
) : Continuation, CoroutineStackFrame, Serializable &#123;

<span class="comment">// This implementation is final. This fact is used to unroll resumeWith recursion.</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span> &#123;
...

  <span class="keyword">try</span> &#123;
    <span class="keyword">val</span> outcome = invokeSuspend(param)
    <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span>
    Result.success(outcome)
  &#125; <span class="keyword">catch</span> (exception: Throwable) &#123;
    Result.failure(exception)
  &#125;
...
&#125;

<span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>)</span></span>: Any?

...
&#125;</code></pre>

<p><code>BaseContinuationImpl</code> is the implementation of the interface <code>Continuation</code>. You can see when a Coroutine tries to get the outcome, it will call <code>invokeSuspend</code> function which is generated by the compiler. If you still remember the example <code>processPost</code> we listed before, the compiled java code shows that the actual computation is in the <code>invokeSuspend</code> function. So the starting flow is:</p>
<pre><code class="highlight kotlin">resumeCancellable(value: T) -&gt; resume(value) -&gt; resumeWith(Result.success(value)) -&gt; invokeSuspend(param)</code></pre>

<p>What does <code>intercepted()</code> do in the <code>startCoroutineCancellable</code>? Let’s see the implementation:</p>
<p><strong>ContinuationImpl</strong></p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ContinuationImpl</span>(
  completion: Continuation&lt;Any?&gt;?,
  <span class="keyword">private</span> <span class="keyword">val</span> _context: CoroutineContext?
) : BaseContinuationImpl(completion) &#123;
...

<span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercepted</span><span class="params">()</span></span>: Continuation&lt;Any?&gt; = intercepted ?: 
  (context[ContinuationInterceptor]?.interceptContinuation(<span class="keyword">this</span>) ?: <span class="keyword">this</span>)
  .also &#123; intercepted = it &#125;

...
&#125;</code></pre>

<p>In <code>intercepted()</code>, it tries to call <code>context[ContinuationInterceptor]?.interceptContinuation(this)</code> to get the <code>Continuation</code>, what’s the <code>interceptContinuation()</code>?</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContinuationInterceptor</span> : <span class="type">CoroutineContext.Element</span> &#123;
...

<span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">interceptContinuation</span><span class="params">(continuation: <span class="type">Continuation</span>)</span></span>: Continuation
...
&#125;</code></pre>

<p>It’s been defined in the interface <code>ContinuationInterceptor</code>. You can find:</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CoroutineDispatcher</span> :
  <span class="type">AbstractCoroutineContextElement</span>(ContinuationInterceptor), 
  ContinuationInterceptor &#123;
...
&#125;</code></pre>

<p>The CoroutineDispatcher implements this interface. Basically, the <code>context[ContinuationInterceptor]</code> is <code>CoroutineDispatcher</code>. When we use <code>interceptContinuation()</code>, it executes the <code>DispatchedContinuation()</code> in the <code>CoroutineDispatcher</code> class. What does the <code>DispatchedContinuation()</code> do?</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">DispatchedContinuation</span>(
  <span class="meta">@JvmField</span> <span class="keyword">val</span> dispatcher: CoroutineDispatcher,
  <span class="meta">@JvmField</span> <span class="keyword">val</span> continuation: Continuation
) : DispatchedTask(MODE_ATOMIC_DEFAULT), 
    CoroutineStackFrame, 
    Continuation <span class="keyword">by</span> continuation &#123;

...

  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span> &#123;
    <span class="comment">// check if need to dispatch</span>
    <span class="keyword">if</span> (dispatcher.isDispatchNeeded(context)) &#123;
      ...

      <span class="comment">// start dispatching</span>
      dispatcher.dispatch(context, <span class="keyword">this</span>)
    &#125; <span class="keyword">else</span> &#123;
      <span class="comment">// if not, execute the task as part of current event loop</span>
      executeUnconfined(state, MODE_ATOMIC_DEFAULT) &#123;
        withCoroutineContext(<span class="keyword">this</span>.context, countOrElement) &#123;
          continuation.resumeWith(result)
        &#125;
      &#125;
    &#125;
  &#125;

  <span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span> <span class="comment">// we need it inline to save us an entry on the stack</span>
  <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeCancellable</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;
    <span class="comment">// check if need to dispatch</span>
    <span class="keyword">if</span> (dispatcher.isDispatchNeeded(context)) &#123;
      ...

      <span class="comment">// start dispatching</span>
      dispatcher.dispatch(context, <span class="keyword">this</span>)
    &#125; <span class="keyword">else</span> &#123;
      <span class="comment">// if not, execute the task as part of current event loop</span>
      executeUnconfined(value, MODE_CANCELLABLE) &#123;
        <span class="keyword">if</span> (!resumeCancelled()) &#123;
          resumeUndispatched(value)
        &#125;
      &#125;
    &#125;
  &#125;

  ...
&#125;</code></pre>

<p>This class intercepts the <code>resumeCancellable</code> and <code>resumeWith</code> functions. And it checks if this Coroutine will need to dispatch.</p>
<p>Alright, so far, we already know how to suspend, resume, and dispatch a Coroutine. It uses different layers to implement different functionalities. For example, <code>BaseContinuationImpl</code> implements the Coroutine resume, <code>DispatchedContinuation</code> implements the dispatching logic. Let’s move on to how to control the <code>Job</code> itself in the next post.</p>
<p>Happy coding, enjoy.</p>
<h4 id="Part1-Introduction"><a href="#Part1-Introduction" class="headerlink" title="Part1 - Introduction"></a>Part1 - <a href="https://personaldevblog.firebaseapp.com/2019/12/27/Android-Coroutines-Introduction">Introduction</a></h4><h4 id="Part3-Callback-Interaction-and-Cancellation"><a href="#Part3-Callback-Interaction-and-Cancellation" class="headerlink" title="Part3 - Callback, Interaction and Cancellation"></a>Part3 - Callback, Interaction and Cancellation</h4><h4 id="Part4-Exception"><a href="#Part4-Exception" class="headerlink" title="Part4 - Exception"></a>Part4 - Exception</h4><h4 id="Part5-Concurrency"><a href="#Part5-Concurrency" class="headerlink" title="Part5 - Concurrency"></a>Part5 - Concurrency</h4><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ol>
<li><a href="https://www.youtube.com/watch?v=_hfBv0a09Jc">KotlinConf 2017 - Introduction to Coroutines by Roman Elizarov</a></li>
<li><a href="https://kotlinlang.org/docs/tutorials/coroutines/async-programming.html">Asynchronous Programming Techniques - Kotlin Programming Language</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Coroutines/" rel="tag"># Coroutines</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/01/Dagger-Series-Something-amazing-about-constructor-injection/" rel="prev" title="Dagger Series: Something amazing about constructor injection">
      <i class="fa fa-chevron-left"></i> Dagger Series: Something amazing about constructor injection
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/16/Shelter-in-place-for-COVID-19-in-San-Francisco/" rel="next" title="Shelter in place for COVID-19 in San Francisco">
      Shelter in place for COVID-19 in San Francisco <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Chauyan">
      <meta itemprop="description" content="Personal dev blog for sharing what I've learned.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="舊金山周記">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android Coroutines - Suspend, Resume, and Dispatch
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-04 23:39:29" itemprop="dateCreated datePublished" datetime="2020-02-04T23:39:29-08:00">2020-02-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-04-12 00:44:44" itemprop="dateModified" datetime="2020-04-12T00:44:44-07:00">2020-04-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android-Dev/" itemprop="url" rel="index"><span itemprop="name">Android Dev</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://chauyanw.files.wordpress.com/2019/08/kotlin-coroutines-1.png?w=2924" alt="kotlin-coroutines-1.png?w=2924"></p>
<p>In the <a href="https://personaldevblog.firebaseapp.com/2019/12/27/Android-Coroutines-Introduction">Introduction</a> section, we already have a big picture of the <code>Coroutines</code> feature, including what it is, how we can use it, and other basic concepts. In this article, I will introduce another critical keyword <code>suspend</code>:</p>
<span id="more"></span>

<h4 id="What’s-a-suspend-function"><a href="#What’s-a-suspend-function" class="headerlink" title="What’s a suspend function?"></a>What’s a suspend function?</h4><p>Remember the example we use before:</p>
<pre><code class="highlight kotlin"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">requestToken</span><span class="params">()</span></span>: Token &#123; ... &#125;
<span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">createPost</span><span class="params">(token: <span class="type">Token</span>, item: <span class="type">Item</span>)</span></span>: Post &#123; ... &#125;
<span class="function"><span class="keyword">fun</span> <span class="title">processPost</span><span class="params">(post: <span class="type">Post</span>)</span></span> &#123; ... &#125;

<span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">postItem</span><span class="params">(item: <span class="type">Item</span>)</span></span> &#123;
  GlobalScope.launch &#123;
    <span class="keyword">val</span> token = requestToken()
    <span class="keyword">val</span> post = createPost(token, item)
    processPost(post)
  &#125;
&#125;</code></pre>

<p>You can see the keyword <code>suspend</code> in front of a function. What does <code>suspend</code> keyword mean? If you compile the Kotlin code, you can see something like this:</p>
<pre><code class="highlight java"><span class="comment">// declaration: requestToken(kotlin.coroutines.Continuation&lt;? super kotlin.Unit&gt;)</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="title function_">requestToken</span><span class="params">(Lkotlin/coroutines/Continuation;)</span>Ljava/lang/Object;</code></pre>

<p>The code snap above is what we decompile into java code.</p>
<pre><code class="highlight kotlin"><span class="meta">@Nullable</span>
<span class="keyword">public</span> <span class="keyword">final</span> Object requestToken(<span class="meta">@NotNull</span> Continuation $completion) &#123;
  <span class="keyword">return</span> <span class="built_in">Unit</span>.INSTANCE;
&#125;</code></pre>

<p>This is a bytecode&#x2F;compiled-java-code sample for this suspend function - requestToken(). We can find there’s a parameter passed into requestToken(), which is a <code>Continuation.</code> What’s a <code>Continuation</code>?</p>
<pre><code class="highlight kotlin"><span class="comment">/**</span>
<span class="comment">* Interface representing a continuation after a suspension point that returns a value of type `T`.</span>
<span class="comment">*/</span>
<span class="meta">@SinceKotlin(<span class="string">&quot;1.3&quot;</span>)</span>
<span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Continuation</span> &#123;
  <span class="comment">/**</span>
<span class="comment">  * The context of the coroutine that corresponds to this continuation.</span>
<span class="comment">  */</span>
  <span class="keyword">public</span> <span class="keyword">val</span> context: CoroutineContext

  <span class="comment">/**</span>
<span class="comment">  * Resumes the execution of the corresponding coroutine passing a successful or failed [result] as the</span>
<span class="comment">  * return value of the last suspension point.</span>
<span class="comment">  */</span>
  <span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span>
&#125;</code></pre>

<p>It’s an interface for resuming the suspended point. Here’s an example when you try to use <code>CoroutineScope.Launch</code>:</p>
<pre><code class="highlight kotlin">GlobalScope.launch &#123;
  <span class="keyword">val</span> token = requestToken()
  <span class="keyword">val</span> post = createPost(token)
  processPost(post)
&#125;</code></pre>

<p>it will become something like:</p>
<pre><code class="highlight java"><span class="meta">@Nullable</span>
<span class="keyword">public</span> <span class="keyword">final</span> Object <span class="title function_">invokeSuspend</span><span class="params">(<span class="meta">@NotNull</span> Object $result)</span> &#123;
  Object var10000;
  label17: &#123;
    <span class="type">Object</span> <span class="variable">var5</span> <span class="operator">=</span> IntrinsicsKt.getCOROUTINE_SUSPENDED();
    CoroutineScope $<span class="built_in">this</span>$launch;
    Token token;
    MainActivity var6;
    <span class="keyword">switch</span>(<span class="built_in">this</span>.label) &#123;
      <span class="keyword">case</span> <span class="number">0</span>:
        ResultKt.throwOnFailure($result);
        $<span class="built_in">this</span>$launch = <span class="built_in">this</span>.p$;
        var6 = MainActivity.<span class="built_in">this</span>;
        <span class="built_in">this</span>.L$<span class="number">0</span> = $<span class="built_in">this</span>$launch;
        <span class="built_in">this</span>.label = <span class="number">1</span>;
        var10000 = var6.requestToken(<span class="built_in">this</span>);
        <span class="keyword">if</span> (var10000 == var5) &#123;
          <span class="keyword">return</span> var5;
        &#125;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number">1</span>:
        $<span class="built_in">this</span>$launch = (CoroutineScope)<span class="built_in">this</span>.L$<span class="number">0</span>;
        ResultKt.throwOnFailure($result);
        var10000 = $result;
      <span class="keyword">break</span>;
      <span class="keyword">case</span> <span class="number">2</span>:
        token = (Token)<span class="built_in">this</span>.L$<span class="number">1</span>;
        $<span class="built_in">this</span>$launch = (CoroutineScope)<span class="built_in">this</span>.L$<span class="number">0</span>;
        ResultKt.throwOnFailure($result);
        var10000 = $result;
        <span class="keyword">break</span> label17;
      <span class="keyword">default</span>:
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;call to &#x27;resume&#x27; before &#x27;invoke&#x27; with coroutine&quot;</span>);
    &#125;

    token = (Token)var10000;
    var6 = MainActivity.<span class="built_in">this</span>;
    <span class="built_in">this</span>.L$<span class="number">0</span> = $<span class="built_in">this</span>$launch;
    <span class="built_in">this</span>.L$<span class="number">1</span> = token;
    <span class="built_in">this</span>.label = <span class="number">2</span>;
    var10000 = var6.createPost(token, <span class="built_in">this</span>);
    <span class="keyword">if</span> (var10000 == var5) &#123;
      <span class="keyword">return</span> var5;
    &#125;
  &#125;

  <span class="type">Post</span> <span class="variable">post</span> <span class="operator">=</span> (Post)var10000;
  MainActivity.<span class="built_in">this</span>.processPost(post);
  <span class="keyword">return</span> Unit.INSTANCE;
&#125;</code></pre>

<p>In a Coroutine, it doesn’t use a callback function to return value. Instead, it uses the state machine to control what will respond to the next state. A suspend function will block the Coroutine when it’s in, but it wouldn’t block the thread. When it executes the suspend function, it won’t block the whole thread. The current thread can still do other jobs.</p>
<pre><code class="highlight kotlin">Thread &#123;

  <span class="keyword">val</span> context = newSingleThreadContext(<span class="string">&quot;Test Thread&quot;</span>)
  GlobalScope.launch (context) &#123;
    println(<span class="string">&quot;Start first coroutine.&quot;</span>)
    delay(<span class="number">200</span>)
    println(<span class="string">&quot;Resume first coroutine after delay 200ms&quot;</span>)
  &#125;

  GlobalScope.launch (context)&#123;
    println(<span class="string">&quot;Start second coroutine.&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;Resume second coroutine after delay 100ms&quot;</span>)
  &#125;

  Thread.sleep(<span class="number">500</span>)
&#125;.start()</code></pre>

<p>the result:</p>
<pre><code class="highlight text">2019-08-17 21:25:22.437 I/System.out: Start first coroutine.
2019-08-17 21:25:22.473 I/System.out: Start second coroutine.
2019-08-17 21:25:22.574 I/System.out: Resume second coroutine after delay 100ms
2019-08-17 21:25:22.656 I/System.out: Resume first coroutine after delay 200ms</code></pre>

<p>That’s why a Coroutine is very lightweight, and you can create it anytime without spending many resources on creating a Coroutine. After this, you might have a question: after resuming the suspended status, current Coroutine will still run on the same thread?</p>
<p>If you remember, I mentioned <code>Dispatcher</code> would decide which thread a Coroutine should run. There are two categories of dispatcher - <code>confined</code> &amp; <code>unconfined.</code> The <code>Default,</code> <code>Main,</code> and <code>IO</code> belong to <code>Confined</code> category, and <code>Unconfined</code> is <code>unconfined.</code> Let’s create two different coroutines and use <code>Confined</code> &amp; <code>Unconfined</code> dispatchers to see what will happen.</p>
<pre><code class="highlight kotlin">Thread &#123;
  GlobalScope.launch (Dispatchers.Main) &#123;
    println(<span class="string">&quot;First coroutine runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;First coroutine resumes and runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
&#125;

  GlobalScope.launch (Dispatchers.Unconfined)&#123;
    println(<span class="string">&quot;Second coroutine runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
    delay(<span class="number">100</span>)
    println(<span class="string">&quot;Second coroutine resumes and runs in <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)
&#125;

  Thread.sleep(<span class="number">500</span>)
&#125;.start()</code></pre>

<p>Result:</p>
<pre><code class="highlight plaintext">2019-08-17 21:43:22.895 I/System.out: Second coroutine runs in Thread-4
2019-08-17 21:43:22.947 I/System.out: First coroutine runs in main
2019-08-17 21:43:23.005 I/System.out: Second coroutine resumes and runs in kotlinx.coroutines.DefaultExecutor
2019-08-17 21:43:23.050 I/System.out: First coroutine resumes and runs in main</code></pre>

<p>When you use a <code>confined</code> dispatcher, no matter when you suspend the Coroutine, it would still run on the same thread after it resumes for the <code>Dispatchers.Unconfined</code> setting, it would first start on the caller thread but continue on a thread based on where the suspend function is.</p>
<p>So far, I introduce how the suspend function works, but it’s still worth going through how to create a Coroutine, start it and resume mechanism, especially it would be great to know how to switch different Coroutines. Let’s dig in a little bit deeper.</p>
<p>Go back to the <code>CoroutineScope.Launch</code>:</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> CoroutineScope.<span class="title">launch</span><span class="params">(</span></span>
<span class="params"><span class="function">  context: <span class="type">CoroutineContext</span> = EmptyCoroutineContext,</span></span>
<span class="params"><span class="function">  start: <span class="type">CoroutineStart</span> = CoroutineStart.DEFAULT,</span></span>
<span class="params"><span class="function">  block: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">Unit</span></span></span>
<span class="params"><span class="function">)</span></span>: Job &#123;
  <span class="keyword">val</span> newContext = newCoroutineContext(context)
  <span class="keyword">val</span> coroutine = <span class="keyword">if</span> (start.isLazy)
      LazyStandaloneCoroutine(newContext, block) 
    <span class="keyword">else</span>
      StandaloneCoroutine(newContext, active = <span class="literal">true</span>)
  coroutine.start(start, coroutine, block)
  <span class="keyword">return</span> coroutine
&#125;</code></pre>

<p>In general, the <code>start</code> parameter will be <code>CoroutineStart.DEFAULT</code>. It would go to here once the start function calls:</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;R, T&gt;</span> <span class="params">(<span class="keyword">suspend</span> (R)</span></span> -&gt; T).startCoroutineCancellable(
  receiver: R, 
  completion: Continuation
) = runSafely(completion) &#123;
  createCoroutineUnintercepted(
    receiver, completion
  ).intercepted().resumeCancellable(<span class="built_in">Unit</span>)
&#125;</code></pre>

<p>It eventually calls the function - <code>createCoroutineUnintercepted</code> to create a Coroutine. What does this function do?</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">actual</span> <span class="function"><span class="title">fun</span> <span class="params">(<span class="keyword">suspend</span> ()</span></span> -&gt; T).createCoroutineUnintercepted(
  completion: Continuation
): Continuation &#123;
  <span class="keyword">val</span> probeCompletion = probeCoroutineCreated(completion)
  <span class="keyword">return</span> <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">is</span> BaseContinuationImpl)
      create(probeCompletion)
    <span class="keyword">else</span>
      createCoroutineFromSuspendFunction(probeCompletion) &#123;
        (<span class="keyword">this</span> <span class="keyword">as</span> Function1&lt;Continuation, Any?&gt;).invoke(it)
      &#125;
&#125;</code></pre>

<p>It creates a Coroutine, which is not intercepted without a receiver but with a result type <code>T.</code> This function creates a new and fresh instance of suspendable computation every time when it is invoked. To start executing this prepared Coroutine, it would call <code>resume(Unit)</code> on the returned Continuation instance. So, remember <code>createCoroutineUnintercepted</code> that will call <code>resumeCancellable</code> to execute a created Coroutine.</p>
<p><strong>resumeCancellable</strong> function</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="function"><span class="keyword">fun</span> Continuation.<span class="title">resumeCancellable</span><span class="params">(value: <span class="type">T</span>)</span></span> = <span class="keyword">when</span> (<span class="keyword">this</span>) &#123;
  <span class="keyword">is</span> DispatchedContinuation -&gt; resumeCancellable(value)
  <span class="keyword">else</span> -&gt; resume(value)
&#125;</code></pre>

<p><strong>resume</strong> function</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> Continuation.<span class="title">resume</span><span class="params">(value: <span class="type">T</span>)</span></span>: <span class="built_in">Unit</span> =
  resumeWith(Result.success(value))</code></pre>

<p>In the resume function, it calls the <code>resumeWith</code> function in a Continuation. Let’s check how it works.</p>
<p><strong>BaseContinuationImpl</strong></p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BaseContinuationImpl</span>(
  <span class="comment">// This is `public val` so that it is private on JVM and cannot be modified by untrusted code, yet</span>
  <span class="comment">// it has a public getter (since even untrusted code is allowed to inspect its call stack).</span>
  <span class="keyword">public</span> <span class="keyword">val</span> completion: Continuation?
) : Continuation, CoroutineStackFrame, Serializable &#123;

<span class="comment">// This implementation is final. This fact is used to unroll resumeWith recursion.</span>
<span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span> &#123;
...

  <span class="keyword">try</span> &#123;
    <span class="keyword">val</span> outcome = invokeSuspend(param)
    <span class="keyword">if</span> (outcome === COROUTINE_SUSPENDED) <span class="keyword">return</span>
    Result.success(outcome)
  &#125; <span class="keyword">catch</span> (exception: Throwable) &#123;
    Result.failure(exception)
  &#125;
...
&#125;

<span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="function"><span class="keyword">fun</span> <span class="title">invokeSuspend</span><span class="params">(result: <span class="type">Result</span>)</span></span>: Any?

...
&#125;</code></pre>

<p><code>BaseContinuationImpl</code> is the implementation of the interface <code>Continuation</code>. You can see when a Coroutine tries to get the outcome, it will call <code>invokeSuspend</code> function which is generated by the compiler. If you still remember the example <code>processPost</code> we listed before, the compiled java code shows that the actual computation is in the <code>invokeSuspend</code> function. So the starting flow is:</p>
<pre><code class="highlight kotlin">resumeCancellable(value: T) -&gt; resume(value) -&gt; resumeWith(Result.success(value)) -&gt; invokeSuspend(param)</code></pre>

<p>What does <code>intercepted()</code> do in the <code>startCoroutineCancellable</code>? Let’s see the implementation:</p>
<p><strong>ContinuationImpl</strong></p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ContinuationImpl</span>(
  completion: Continuation&lt;Any?&gt;?,
  <span class="keyword">private</span> <span class="keyword">val</span> _context: CoroutineContext?
) : BaseContinuationImpl(completion) &#123;
...

<span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercepted</span><span class="params">()</span></span>: Continuation&lt;Any?&gt; = intercepted ?: 
  (context[ContinuationInterceptor]?.interceptContinuation(<span class="keyword">this</span>) ?: <span class="keyword">this</span>)
  .also &#123; intercepted = it &#125;

...
&#125;</code></pre>

<p>In <code>intercepted()</code>, it tries to call <code>context[ContinuationInterceptor]?.interceptContinuation(this)</code> to get the <code>Continuation</code>, what’s the <code>interceptContinuation()</code>?</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ContinuationInterceptor</span> : <span class="type">CoroutineContext.Element</span> &#123;
...

<span class="keyword">public</span> <span class="function"><span class="keyword">fun</span> <span class="title">interceptContinuation</span><span class="params">(continuation: <span class="type">Continuation</span>)</span></span>: Continuation
...
&#125;</code></pre>

<p>It’s been defined in the interface <code>ContinuationInterceptor</code>. You can find:</p>
<pre><code class="highlight kotlin"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CoroutineDispatcher</span> :
  <span class="type">AbstractCoroutineContextElement</span>(ContinuationInterceptor), 
  ContinuationInterceptor &#123;
...
&#125;</code></pre>

<p>The CoroutineDispatcher implements this interface. Basically, the <code>context[ContinuationInterceptor]</code> is <code>CoroutineDispatcher</code>. When we use <code>interceptContinuation()</code>, it executes the <code>DispatchedContinuation()</code> in the <code>CoroutineDispatcher</code> class. What does the <code>DispatchedContinuation()</code> do?</p>
<pre><code class="highlight kotlin"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">DispatchedContinuation</span>(
  <span class="meta">@JvmField</span> <span class="keyword">val</span> dispatcher: CoroutineDispatcher,
  <span class="meta">@JvmField</span> <span class="keyword">val</span> continuation: Continuation
) : DispatchedTask(MODE_ATOMIC_DEFAULT), 
    CoroutineStackFrame, 
    Continuation <span class="keyword">by</span> continuation &#123;

...

  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeWith</span><span class="params">(result: <span class="type">Result</span>)</span></span> &#123;
    <span class="comment">// check if need to dispatch</span>
    <span class="keyword">if</span> (dispatcher.isDispatchNeeded(context)) &#123;
      ...

      <span class="comment">// start dispatching</span>
      dispatcher.dispatch(context, <span class="keyword">this</span>)
    &#125; <span class="keyword">else</span> &#123;
      <span class="comment">// if not, execute the task as part of current event loop</span>
      executeUnconfined(state, MODE_ATOMIC_DEFAULT) &#123;
        withCoroutineContext(<span class="keyword">this</span>.context, countOrElement) &#123;
          continuation.resumeWith(result)
        &#125;
      &#125;
    &#125;
  &#125;

  <span class="meta">@Suppress(<span class="string">&quot;NOTHING_TO_INLINE&quot;</span>)</span> <span class="comment">// we need it inline to save us an entry on the stack</span>
  <span class="keyword">inline</span> <span class="function"><span class="keyword">fun</span> <span class="title">resumeCancellable</span><span class="params">(value: <span class="type">T</span>)</span></span> &#123;
    <span class="comment">// check if need to dispatch</span>
    <span class="keyword">if</span> (dispatcher.isDispatchNeeded(context)) &#123;
      ...

      <span class="comment">// start dispatching</span>
      dispatcher.dispatch(context, <span class="keyword">this</span>)
    &#125; <span class="keyword">else</span> &#123;
      <span class="comment">// if not, execute the task as part of current event loop</span>
      executeUnconfined(value, MODE_CANCELLABLE) &#123;
        <span class="keyword">if</span> (!resumeCancelled()) &#123;
          resumeUndispatched(value)
        &#125;
      &#125;
    &#125;
  &#125;

  ...
&#125;</code></pre>

<p>This class intercepts the <code>resumeCancellable</code> and <code>resumeWith</code> functions. And it checks if this Coroutine will need to dispatch.</p>
<p>Alright, so far, we already know how to suspend, resume, and dispatch a Coroutine. It uses different layers to implement different functionalities. For example, <code>BaseContinuationImpl</code> implements the Coroutine resume, <code>DispatchedContinuation</code> implements the dispatching logic. Let’s move on to how to control the <code>Job</code> itself in the next post.</p>
<p>Happy coding, enjoy.</p>
<h4 id="Part1-Introduction"><a href="#Part1-Introduction" class="headerlink" title="Part1 - Introduction"></a>Part1 - <a href="https://personaldevblog.firebaseapp.com/2019/12/27/Android-Coroutines-Introduction">Introduction</a></h4><h4 id="Part3-Callback-Interaction-and-Cancellation"><a href="#Part3-Callback-Interaction-and-Cancellation" class="headerlink" title="Part3 - Callback, Interaction and Cancellation"></a>Part3 - Callback, Interaction and Cancellation</h4><h4 id="Part4-Exception"><a href="#Part4-Exception" class="headerlink" title="Part4 - Exception"></a>Part4 - Exception</h4><h4 id="Part5-Concurrency"><a href="#Part5-Concurrency" class="headerlink" title="Part5 - Concurrency"></a>Part5 - Concurrency</h4><h4 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h4><ol>
<li><a href="https://www.youtube.com/watch?v=_hfBv0a09Jc">KotlinConf 2017 - Introduction to Coroutines by Roman Elizarov</a></li>
<li><a href="https://kotlinlang.org/docs/tutorials/coroutines/async-programming.html">Asynchronous Programming Techniques - Kotlin Programming Language</a></li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Coroutines/" rel="tag"># Coroutines</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/01/01/Dagger-Series-Something-amazing-about-constructor-injection/" rel="prev" title="Dagger Series: Something amazing about constructor injection">
      <i class="fa fa-chevron-left"></i> Dagger Series: Something amazing about constructor injection
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/16/Shelter-in-place-for-COVID-19-in-San-Francisco/" rel="next" title="Shelter in place for COVID-19 in San Francisco">
      Shelter in place for COVID-19 in San Francisco <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>
  <div>
  <script type="text/javascript">
	atOptions = {
		'key' : '335b6d5fd0ce419dba15708955862700',
		'format' : 'iframe',
		'height' : 60,
		'width' : 468,
		'params' : {}
	};
	document.write('<scr' + 'ipt type="text/javascript" src="http' + (location.protocol === 'https:' ? 's' : '') + '://www.madcpms.com/335b6d5fd0ce419dba15708955862700/invoke.js"></scr' + 'ipt>');
</script>
  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#What%E2%80%99s-a-suspend-function"><span class="nav-number">1.</span> <span class="nav-text">What’s a suspend function?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Part1-Introduction"><span class="nav-number">2.</span> <span class="nav-text">Part1 - Introduction</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Part3-Callback-Interaction-and-Cancellation"><span class="nav-number">3.</span> <span class="nav-text">Part3 - Callback, Interaction and Cancellation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Part4-Exception"><span class="nav-number">4.</span> <span class="nav-text">Part4 - Exception</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Part5-Concurrency"><span class="nav-number">5.</span> <span class="nav-text">Part5 - Concurrency</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Reference"><span class="nav-number">6.</span> <span class="nav-text">Reference</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Chauyan</p>
  <div class="site-description" itemprop="description">Personal dev blog for sharing what I've learned.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">67</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">102</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/wangchauyan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;wangchauyan" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:wang.chauyan@gmail.com" title="E-Mail → mailto:wang.chauyan@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/deathrid" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;deathrid" rel="noopener" target="_blank"><i class="twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/chauyanw/" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;chauyanw&#x2F;" rel="noopener" target="_blank"><i class="facebook fa-fw"></i>FB Page</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Chauyan</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://chauyan.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "http://yoursite.com/2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/";
    this.page.identifier = "2020/02/04/Android-Coroutines-Suspend-Resume-and-Dispatch/";
    this.page.title = "Android Coroutines - Suspend, Resume, and Dispatch";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://chauyan.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

  <!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-analytics.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCqTNIS0PZUFVzFmQOCcFEheWocG9daymY",
    authDomain: "personaldevblog.firebaseapp.com",
    databaseURL: "https://personaldevblog.firebaseio.com",
    projectId: "personaldevblog",
    storageBucket: "personaldevblog.appspot.com",
    messagingSenderId: "785621246959",
    appId: "1:785621246959:web:87cab80109fd2701f44c1a",
    measurementId: "G-4KWYT0P8Z8"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
</script>
</body>
</html>
